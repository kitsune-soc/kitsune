[profile.dev.package]
backtrace = { opt-level = 3 }
num-bigint-dig = { opt-level = 3 }
taplo = { debug-assertions = false } # A debug assertion will make the xtask panic with too long trailing comments

# The profile that 'cargo dist' will build with
[profile.dist]
inherits = "release"
codegen-units = 1
lto = true
strip = true

[profile.dist-smol]
inherits = "dist"
opt-level = "z"

[profile.release]
panic = "abort"

[workspace]
members = [
    "crates/kitsune-activitypub",
    "crates/kitsune-cache",
    "crates/kitsune-captcha",
    "crates/kitsune-config",
    "crates/kitsune-core",
    "crates/kitsune-db",
    "crates/kitsune-derive",
    "crates/kitsune-derive/impl",
    "crates/kitsune-email",
    "crates/kitsune-embed",
    "crates/kitsune-error",
    "crates/kitsune-federation",
    "crates/kitsune-federation-filter",
    "crates/kitsune-http-client",
    "crates/kitsune-jobs",
    "crates/kitsune-language",
    "crates/kitsune-mastodon",
    "crates/kitsune-observability",
    "crates/kitsune-oidc",
    "crates/kitsune-s3",
    "crates/kitsune-scss-compiler",
    "crates/kitsune-search",
    "crates/kitsune-service",
    "crates/kitsune-storage",
    "crates/kitsune-test",
    "crates/kitsune-type",
    "crates/kitsune-url",
    "crates/kitsune-util",
    "crates/kitsune-wasm-mrf",
    "crates/kitsune-wasm-mrf/example-mrf",
    "crates/kitsune-webfinger",
    "kitsune",
    "kitsune-cli",
    "kitsune-job-runner",
    "lib/athena",
    "lib/blowocking",
    "lib/cursiv",
    "lib/geomjeungja",
    "lib/http-signatures",
    "lib/just-retry",
    "lib/masto-id-convert",
    "lib/mrf-manifest",
    "lib/mrf-tool",
    "lib/multiplex-pool",
    "lib/post-process",
    "lib/speedy-uuid",
    "lib/tick-tock-mock",
    "lib/tower-http-digest",
    "lib/tower-stop-using-brave",
    "lib/tower-x-clacks-overhead",
    "lib/trials",
    "lib/trials/macros",
    "xtask",
]
resolver = "2"

[workspace.lints.clippy]
all = "warn"
pedantic = "warn"

cast_lossless = "allow"
cast_possible_truncation = "allow"
cast_possible_wrap = "allow"
cast_sign_loss = "allow"
module_name_repetitions = "allow"
missing_errors_doc = "allow"
missing_panics_doc = "allow"
no_effect_underscore_binding = "allow"

[workspace.lints.rust]
forbidden_lint_groups = "allow"
rust_2018_idioms = "forbid"
unsafe_code = "deny"

[workspace.package]
authors = ["The Kitsune authors"]
edition = "2021"
version = "0.0.1-pre.6"
license = "AGPL-3.0-or-later"

# Config for 'cargo dist'
[workspace.metadata.dist]
# Whether to pass --all-features to cargo build
all-features = true
# The preferred cargo-dist version to use in CI (Cargo.toml SemVer syntax)
cargo-dist-version = "0.13.2"
# CI backends to support
ci = ["github"]
# The installers to generate for each app
installers = ["powershell", "shell"]
# Target platforms to build apps for (Rust target-triple syntax)
targets = [
    "aarch64-apple-darwin",
    "x86_64-apple-darwin",
    "x86_64-pc-windows-msvc",
    "x86_64-unknown-linux-gnu",
]
# Publish jobs to run in CI
pr-run-mode = "plan"
# Whether to install an updater program
install-updater = true

[patch.crates-io]
diesel-async = { git = "https://github.com/weiznich/diesel_async.git", rev = "d02798c67065d763154d7272dd0c09b39757d0f2" }
scraper = { git = "https://github.com/causal-agent/scraper.git", rev = "d67111f5cc0b7da6e6ff10e4549d87cf09ba3e5b" }
tokio-postgres-rustls = { git = "https://github.com/jbg/tokio-postgres-rustls.git", rev = "b16c1bc0f5d4f91324174fd1bd839d743a70f86a" }

# Patch to make OpenTelemetry with with hyper 1
opentelemetry = { git = "https://github.com/open-telemetry/opentelemetry-rust.git", rev = "b44cb130e4a102b0d676289e91c003f4b1008d08" }
opentelemetry-http = { git = "https://github.com/open-telemetry/opentelemetry-rust.git", rev = "b44cb130e4a102b0d676289e91c003f4b1008d08" }
opentelemetry-otlp = { git = "https://github.com/open-telemetry/opentelemetry-rust.git", rev = "b44cb130e4a102b0d676289e91c003f4b1008d08" }
opentelemetry_sdk = { git = "https://github.com/open-telemetry/opentelemetry-rust.git", rev = "b44cb130e4a102b0d676289e91c003f4b1008d08" }
tonic = { git = "https://github.com/hyperium/tonic.git", rev = "9b306af386528f11dbd022bc372d367adc4e96b5" }
tracing-opentelemetry = { git = "https://github.com/aumetra/tracing-opentelemetry.git", branch = "v0.1.x-http1" }
